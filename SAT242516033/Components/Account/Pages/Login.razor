@page "/login"
@page "/Account/Login"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using SAT242516033.Data
@attribute [AllowAnonymous]
@layout SAT242516033.Components.Layout.EmptyLayout
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavManager
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<div class="container d-flex justify-content-center align-items-center" style="height: 80vh;">
    <div class="card shadow-lg p-4" style="width: 400px;">
        <div class="text-center mb-4">
            <h3 class="fw-bold text-primary">Giriş Yap</h3>
            <p class="text-muted">Personel Yönetim Sistemi</p>
        </div>

        <EditForm Model="@model" OnValidSubmit="GirisYap">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            <div class="mb-3">
                <label class="form-label">Kullanıcı Adı</label>
                <InputText @bind-Value="model.KullaniciAdi" class="form-control" autocomplete="username" />
            </div>
            <div class="mb-3">
                <label class="form-label">Şifre</label>
                <InputText @bind-Value="model.Sifre" type="password" class="form-control" autocomplete="current-password" />
            </div>

            @if (!string.IsNullOrWhiteSpace(hataMesaji))
            {
                <div class="alert alert-danger p-2 small">@hataMesaji</div>
            }

            <button type="submit" class="btn btn-primary w-100 py-2">Giriş Yap</button>
        </EditForm>

        <div class="text-center mt-3">
            <button type="button" class="btn btn-link" @onclick="KayitOl">Kayıt Ol</button>
        </div>
    </div>
</div>

@code {
    private LoginModel model { get; set; } = new LoginModel();

    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    private string? hataMesaji;

    private async Task GirisYap()
    {
        hataMesaji = null;
        var signInResult = await SignInManager.PasswordSignInAsync(
            model.KullaniciAdi,
            model.Sifre,
            isPersistent: false,
            lockoutOnFailure: false);

        if (!signInResult.Succeeded)
        {
            hataMesaji = "Kullanıcı adı veya şifre hatalı!";
            return;
        }

        var user = await UserManager.FindByNameAsync(model.KullaniciAdi);
        var isAdmin = user != null && await UserManager.IsInRoleAsync(user, "Admin");

        if (isAdmin)
        {
            NavManager.NavigateTo("/Yonetim/rol-yonetimi");
            return;
        }

        var target = "/";
        if (!string.IsNullOrWhiteSpace(ReturnUrl) && Uri.IsWellFormedUriString(ReturnUrl, UriKind.Relative))
        {
            target = ReturnUrl;
        }

        NavManager.NavigateTo(target);
    }

    private void KayitOl()
    {
        var target = "/Account/Register";
        if (!string.IsNullOrWhiteSpace(ReturnUrl) && Uri.IsWellFormedUriString(ReturnUrl, UriKind.Relative))
        {
            target = $"/Account/Register?returnUrl={Uri.EscapeDataString(ReturnUrl)}";
        }

        NavManager.NavigateTo(target);
    }

    public class LoginModel
    {
        [Required(ErrorMessage = "Kullanıcı adı zorunludur.")]
        public string KullaniciAdi { get; set; } = string.Empty;

        [Required(ErrorMessage = "Şifre zorunludur.")]
        public string Sifre { get; set; } = string.Empty;
    }
}
