@page "/login"
@page "/Account/Login"
@using Microsoft.AspNetCore.Authorization
@using SAT242516033.Data
@using SAT242516033.Models
@using SAT242516033.Models.MyServices
@attribute [AllowAnonymous]
@layout SAT242516033.Components.Layout.EmptyLayout
@inject AuthService AuthService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavManager
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<div class="container d-flex justify-content-center align-items-center" style="height: 80vh;">
    <div class="card shadow-lg p-4" style="width: 400px; border-radius: 12px;">
        

        <EditForm Model="@model" OnValidSubmit="GirisYap" FormName="login-form">
            <DataAnnotationsValidator />

            <div class="mb-3">
                <label class="form-label">Kullanıcı Adı</label>
                <InputText @bind-Value="model.KullaniciAdi" class="form-control" placeholder="Örn: ege" />
            </div>

            <div class="mb-3">
                <label class="form-label">Şifre</label>
                <InputText @bind-Value="model.Sifre" type="password" class="form-control" placeholder="******" />
            </div>

            @if (!string.IsNullOrEmpty(hataMesaji))
            {
                <div class="alert alert-danger p-2 small text-center">@hataMesaji</div>
            }

            <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">Giriş Yap</button>
        </EditForm>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    public LoginModel model { get; set; } = new LoginModel();

    private string? hataMesaji;

    private async Task GirisYap()
    {
        if (string.IsNullOrWhiteSpace(model.KullaniciAdi) || string.IsNullOrWhiteSpace(model.Sifre))
        {
            hataMesaji = "Lütfen tüm alanları doldur kanka.";
            return;
        }

        // 1. Veritabanından kullanıcıyı kontrol et
        var kullanici = await AuthService.LoginAsync(model.KullaniciAdi, model.Sifre);

        if (kullanici != null)
        {
            // 2. ROL TANIMLAMA (Kritik Nokta)
            // Eğer RolId 1 ise 'Admin', değilse 'User' olarak sisteme bildiriyoruz.
            string atanacakRol = (kullanici.RolId == 1) ? "Admin" : "User";

            var customAuthStateProvider = (CustomAuthStateProvider)AuthStateProvider;

            // 3. Oturumu Rol Bilgisiyle Güncelle
            await customAuthStateProvider.UpdateAuthenticationState(new UserSession
            {
                UserName = kullanici.KullaniciAdi ?? "Bilinmeyen",
                Role = atanacakRol // Bu string sayesinde [Authorize(Roles="Admin")] kontrolleri çalışır
            });

            // 4. Yönlendir
            NavManager.NavigateTo("/", forceLoad: false);
        }
        else
        {
            hataMesaji = "Kullanıcı adı veya şifre hatalı!";
        }
    }
}