@page "/orders/edit/{Id:int}"
@using SAT242516033.Components.Pages.Models
@inject Providers.IMyDbModel_Provider DbProvider

<PageTitle>Edit Order</PageTitle>

<h3>Edit Order</h3>

@if (order == null)
{
    <p>Loading...</p>
}
else
{
    <div>
        <label>Product</label>
        <select @bind="order.ProductId">
            @foreach (var p in products)
            {
                <option value="@p.Id">@p.Name</option>
            }
        </select>
    </div>
    <div>
        <label>Quantity</label>
        <input type="number" @bind="order.Quantity" />
    </div>
    <div>
        <label>Status</label>
        <input @bind="order.Status" />
    </div>
    <button @onclick="Save">Save</button>
    <button @onclick="Cancel">Cancel</button>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private OrderDto? order;
    private List<ProductDto> products = new();

    protected override async Task OnInitializedAsync()
    {
        products = (await DbProvider.GetItems<ProductDto>("usp_GetProducts")).ToList();
        order = (await DbProvider.GetItems<OrderDto>("usp_GetOrderById", ("Id", Id))).FirstOrDefault();
        if (order == null)
        {
            order = new OrderDto { Id = 0, OrderDate = DateTime.Now, Quantity = 1, Status = "New" };
        }
    }

    [Inject]
    public NavigationManager NavManager { get; set; } = default!;

    private async Task Save()
    {
        if (order == null) return;
        await DbProvider.SetItems<object>("usp_SaveOrder",
            ("Id", order.Id),
            ("ProductId", order.ProductId),
            ("Quantity", order.Quantity),
            ("Status", order.Status ?? string.Empty));
        NavManager.NavigateTo("/orders");
    }

    private void Cancel()
    {
        NavManager.NavigateTo("/orders");
    }
}