@page "/Raporlar/pdf-olustur"
@using SAT242516033.Models.Providers
@using SAT242516033.Models.MyDbModels
@using SAT242516033.Data
@using SAT242516033.Models.MyReports
@using QuestPDF.Fluent
@inject IMyDbModel_Provider DbProvider

<div class="container-fluid" style="height: 90vh;">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h3>📄 Sipariş Raporu Önizleme</h3>
    </div>

    @if (pdfDataUrl == null)
    {
        <div class="alert alert-info">
            <div class="spinner-border spinner-border-sm me-2"></div>
            PDF Oluşturuluyor, lütfen bekleyiniz...
        </div>
    }
    else
    {
        @* İŞTE BU SATIR PDF'İ SAYFADA GÖSTERİR *@
        <iframe src="@pdfDataUrl" style="width: 100%; height: 100%; border: 1px solid #ccc; border-radius: 4px;"></iframe>
    }
</div>

@code {
    private string? pdfDataUrl;

    protected override async Task OnInitializedAsync()
    {
        // 1. Verileri Çek
        var sSonuc = await DbProvider.Execute(new MyDbModel<Siparis>(), "sp_Siparisler", true);
        var siparisler = sSonuc?.Items?.ToList() ?? new List<Siparis>();

        // 2. PDF Byte Dizisini Oluştur
        var rapor = new Report_Siparis(siparisler);
        var pdfBytes = rapor.GeneratePdf();

        // 3. Byte dizisini Base64 stringe çevirip iframe'e veriyoruz
        var base64 = Convert.ToBase64String(pdfBytes);
        pdfDataUrl = $"data:application/pdf;base64,{base64}";
    }
}