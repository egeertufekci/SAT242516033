@page "/"
@using SAT242516033.Models.Providers
@using SAT242516033.Models.MyDbModels
@using SAT242516033.Data
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@using Microsoft.Extensions.Localization

@* Sadece giriş yapmış kullanıcılar görebilir *@
@attribute [Authorize]

@* Enjeksiyonlar *@
@inject IMyDbModel_Provider DbProvider
@inject AuthenticationStateProvider AuthStateProvider
@inject IStringLocalizer<Loc> L
@inject ILogger<Home> Logger

<PageTitle>Ana Sayfa - Dashboard</PageTitle>
eeeeeeeeeeeeeeeeeeeeeee
<div class="container-fluid mt-4">
    @* ÜST BÖLÜM: Docker ve Ortam Bilgileri *@
    <div class="alert alert-secondary shadow-sm text-center mb-4">
        <h4 class="text-success fw-bold">Sistem Durumu</h4>
        <div class="row">
            <div class="col-md-6 border-end">
                <span class="text-muted">AKTİF SİTE:</span>
                <span class="badge bg-danger">@($"SITE: {Environment.GetEnvironmentVariable("SITE") ?? "Localhost"}")</span>
            </div>
            <div class="col-md-6">
                <small class="text-muted">Bağlantı Dizini: @(Environment.GetEnvironmentVariable("ConnectionStrings__DefaultConnection") ?? "Yerel Bağlantı")</small>
            </div>
        </div>
    </div>

    @* HOŞGELDİN MESAJI *@
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-6 fw-bold text-primary">Hoşgeldin, @userName!</h1>
            <p class="text-muted">Üretim ve Sipariş Takip Sistemi Özeti</p>
        </div>
    </div>

    @* İSTATİSTİK KARTLARI *@
    <div class="row">
        @* KART 1: MÜŞTERİLER *@
        <div class="col-md-4">
            <div class="card shadow-sm border-start border-primary border-5 mb-3">
                <div class="card-body">
                    <h5 class="card-title text-muted">Toplam Müşteri</h5>
                    <h2 class="fw-bold">@musteriSayisi</h2>
                    <a href="/Operasyon/musteri-yonetimi" class="btn btn-sm btn-outline-primary mt-2">Yönet</a>
                </div>
            </div>
        </div>

        @* KART 2: ÜRÜNLER *@
        <div class="col-md-4">
            <div class="card shadow-sm border-start border-success border-5 mb-3">
                <div class="card-body">
                    <h5 class="card-title text-muted">Stoktaki Ürünler</h5>
                    <h2 class="fw-bold">@urunSayisi</h2>
                    <a href="/Operasyon/urun-yonetimi" class="btn btn-sm btn-outline-success mt-2">Yönet</a>
                </div>
            </div>
        </div>

        @* KART 3: SİPARİŞLER *@
        <div class="col-md-4">
            <div class="card shadow-sm border-start border-warning border-5 mb-3">
                <div class="card-body">
                    <h5 class="card-title text-muted">Toplam Sipariş</h5>
                    <h2 class="fw-bold">@siparisSayisi</h2>
                    <a href="/Operasyon/siparis-yonetimi" class="btn btn-sm btn-outline-warning mt-2">Yönet</a>
                </div>
            </div>
        </div>
    </div>

    @* ALT BÖLÜM: Localization Test *@
    <div class="card mt-5 bg-light shadow-sm">
        <div class="card-body text-center">
            <h3 class="text-dark">Dil Desteği (Localization) Testi</h3>
            <h2 class="text-danger display-5 fw-bold">
                @L["Hello"]
            </h2>
            <p class="text-muted mt-2">
                (Navigasyon çubuğundan dili değiştirerek bu metnin değiştiğini test edebilirsin.)
            </p>
        </div>
    </div>
</div>

@code {
    private string userName = "Kullanıcı";
    private int musteriSayisi = 0;
    private int urunSayisi = 0;
    private int siparisSayisi = 0;

    protected override async Task OnInitializedAsync()
    {
        // 1. Kullanıcı adını Authentication State üzerinden al
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            userName = user.Identity.Name ?? "Kullanıcı";
        }

        // 2. Veritabanı verilerini asenkron olarak çek
        try
        {
            var mSonuc = await DbProvider.Execute<Musteri>("sp_Musteriler");
            if (mSonuc?.Items != null) musteriSayisi = mSonuc.Items.Count();

            var uSonuc = await DbProvider.Execute<Urun>("sp_UrunListele");
            if (uSonuc?.Items != null) urunSayisi = uSonuc.Items.Count();

            var sSonuc = await DbProvider.Execute<Siparis>("sp_Siparisler");
            if (sSonuc?.Items != null) siparisSayisi = sSonuc.Items.Count();
        }
        catch (Exception ex)
        {
            Logger.LogError($"Veri çekme hatası: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var now = DateTime.Now.ToString("HH:mm:ss");
            Logger.LogInformation($"Ana Sayfa Görüntülendi - Saat: {now}");
            Logger.LogWarning("Dashboard başarıyla yüklendi.");
        }
    }
}