@page "/urunler"
@using MyDbModels
@using Providers
@using System.Linq
@using System.Text.Json
@using Microsoft.JSInterop

<PageTitle>Ürünler</PageTitle>

<h3>Ürünler</h3>

@if (_myDbModel != null)
{
    @if (_operation == "list")
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>
                        <button class="btn btn-outline-success"
                                @onclick="() => OnClick_New()">
                            New
                        </button>
                    </th>

                    <th>UrunId</th>
                    <th>UrunAdi</th>
                    <th>SKU</th>
                    <th>BirimFiyat</th>
                    <th>StokAdet</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in _myDbModel.Items)
                {
                    <tr>
                        <td>
                            <button class="btn btn-outline-warning"
                                    @onclick="() => OnClick_Edit(item.UrunId)">
                                Edit
                            </button>
                            <button class="btn btn-outline-danger"
                                    @onclick="() => OnClick_Remove(item.UrunId)">
                                Sil
                            </button>
                        </td>

                        <td>@item.UrunId</td>
                        <td>@item.UrunAdi</td>
                        <td>@item.SKU</td>
                        <td>@item.BirimFiyat</td>
                        <td>@item.StokAdet</td>
                    </tr>
                }
            </tbody>
        </table>

        @if (!string.IsNullOrWhiteSpace(_myDbModel.Message))
        {
            <div class="alert alert-warning mt-2">
                @_myDbModel.Message
            </div>
        }
    }

    <div class="row g-2 align-items-end mb-3">
        <div class="col-md-4">
            <label class="form-label">Filtre (Ad / SKU)</label>
            <input class="form-control" @bind="filterText" @bind:event="oninput" />
        </div>

        <div class="col-md-3">
            <label class="form-label">Sırala</label>
            <select class="form-select" @bind="sortBy">
                <option value="UrunAdi">Ürün Adı</option>
                <option value="SKU">SKU</option>
                <option value="BirimFiyat">Birim Fiyat</option>
                <option value="StokAdet">Stok</option>
            </select>
        </div>

        <div class="col-md-2">
            <label class="form-label">Yön</label>
            <select class="form-select" @bind="sortAsc">
                <option value="true">Artan</option>
                <option value="false">Azalan</option>
            </select>
        </div>

        <div class="col-md-2">
            <label class="form-label">Sayfa Boyutu</label>
            <select class="form-select" @bind="pageSize">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="20">20</option>
            </select>
        </div>

        <div class="col-md-1">
            <button class="btn btn-outline-secondary w-100" @onclick="() => currentPage = 1">↺</button>
        </div>
    </div>


    @if (_operation == "new")
    {
        <input type="text" @bind="_model.UrunAdi" placeholder="UrunAdi" />
        <input type="text" @bind="_model.SKU" placeholder="SKU" />
        <input type="number" step="0.01" @bind="_model.BirimFiyat" placeholder="BirimFiyat" />
        <input type="number" @bind="_model.StokAdet" placeholder="StokAdet" />

        <button class="btn btn-success"
                @onclick="() => OnClick_Add()">
            Add
        </button>
        <button class="btn btn-outline-dark"
                @onclick="() => OnClick_Cancel()">
            Cancel
        </button>
    }

    @if (_operation == "edit")
    {
        <input type="text" @bind="_model.UrunAdi" placeholder="UrunAdi" />
        <input type="text" @bind="_model.SKU" placeholder="SKU" />
        <input type="number" step="0.01" @bind="_model.BirimFiyat" placeholder="BirimFiyat" />
        <input type="number" @bind="_model.StokAdet" placeholder="StokAdet" />

        <button class="btn btn-warning"
                @onclick="() => OnClick_Update()">
            Update
        </button>
        <button class="btn btn-outline-dark"
                @onclick="() => OnClick_Cancel()">
            Cancel
        </button>
    }

    @if (_operation == "remove")
    {
        <input type="text" @bind="_model.UrunAdi" readonly />
        <input type="text" @bind="_model.SKU" readonly />
        <input type="text" value="@_model.BirimFiyat" readonly />
        <input type="text" value="@_model.StokAdet" readonly />

        <button class="btn btn-danger"
                @onclick="() => OnClick_Save()">
            Remove
        </button>
        <button class="btn btn-outline-dark"
                @onclick="() => OnClick_Cancel()">
            Cancel
        </button>
    }
}

@inject IMyDbModel<Model> _myDbModel
@inject IMyDbModel_Provider _myDbModel_Provider
@inject IJSRuntime JS

@code {

    // UI state
    private string filterText = "";
    private string sortBy = "UrunAdi";
    private bool sortAsc = true;

    private int pageSize = 10;
    private int currentPage = 1;


    string _operation = "list";
    Model _model = new Model();

    private void OnClick_New()
    {
        _operation = "new";
        _model = new Model(); // AktifMi default true zaten
    }

    private void OnClick_Edit(int? id)
    {
        _operation = "edit";
        _model = _myDbModel.Items.FirstOrDefault(f => f.UrunId == id) ?? new Model();
    }

    private void OnClick_Remove(int? id)
    {
        _operation = "remove";
        _model = _myDbModel.Items.FirstOrDefault(f => f.UrunId == id) ?? new Model();
    }

    private async void OnClick_Add()
    {
        _operation = "add";

        // ✅ UI'da yok ama DB'de aktif olsun
        _model.AktifMi = true;

        var jsonvalues = JsonSerializer.Serialize(_model);

        var results = await _myDbModel_Provider
            .SetItems<MyDbModel_Result_KeyValue<string, bool>>("sp_Urun_Add_Update_Remove",
                ("operation", _operation),
                ("jsonvalues", jsonvalues)
            );

        var result = results.FirstOrDefault();
        await JS.InvokeVoidAsync("alert", $"{result.Key} : {result.Value}");

        await GetItems();
    }

    private async void OnClick_Update()
    {
        _operation = "update";

        // ✅ güncellemede de aktif kalsın
        _model.AktifMi = true;

        var jsonvalues = JsonSerializer.Serialize(_model);

        var results = await _myDbModel_Provider
            .SetItems<MyDbModel_Result_KeyValue<string, bool>>("sp_Urun_Add_Update_Remove",
                ("operation", _operation),
                ("jsonvalues", jsonvalues)
            );

        var result = results.FirstOrDefault();
        await JS.InvokeVoidAsync("alert", $"{result.Key} : {result.Value}");

        await GetItems();
    }

    private async void OnClick_Save()
    {
        _operation = "remove";

        var jsonvalues = JsonSerializer.Serialize(_model);

        var results = await _myDbModel_Provider
            .SetItems<MyDbModel_Result_KeyValue<string, bool>>("sp_Urun_Add_Update_Remove",
                ("operation", _operation),
                ("jsonvalues", jsonvalues)
            );

        var result = results.FirstOrDefault();
        await JS.InvokeVoidAsync("alert", $"{result.Key} : {result.Value}");

        await GetItems();
    }

    private void OnClick_Cancel()
    {
        _operation = "list";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await GetItems();
        }
    }

    async Task GetItems()
    {
        _operation = "list";
        await _myDbModel_Provider.Execute<Model>(_myDbModel, "sp_UrunListele");
        StateHasChanged();
    }

    class Model
    {
        public int UrunId { get; set; }
        public string UrunAdi { get; set; } = "";
        public string SKU { get; set; } = "";
        public decimal BirimFiyat { get; set; }
        public int StokAdet { get; set; }
        public bool AktifMi { get; set; } = true;
    }
}
