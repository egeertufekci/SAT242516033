@page "/urunler"
@using Providers
@using SAT242516033.Data
@using UrunSiparisTakip.Models
@using Microsoft.EntityFrameworkCore
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@inject ApplicationDbContext Db
@inject ApplicationDbContext Db
@inject IMyDbModel_Provider Provider

<h2 class="mt-3">Ürünler</h2>

@if (!string.IsNullOrWhiteSpace(statusMessage))
{
    <div class="alert @statusClass" role="alert">@statusMessage</div>
}

<div class="row g-3 align-items-start mt-2">
    <div class="col-12 col-xl-8 col-xxl-9">
        <div class="card shadow-sm">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="text-primary mb-0">Ürün Listesi</h5>
                    <button class="btn btn-outline-primary btn-sm" @onclick="RefreshAsync">Listeyi Yenile</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-sm align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 60px;">#</th>
                                <th>Ad</th>
                                <th style="width: 120px;">SKU</th>
                                <th style="width: 120px;">Fiyat</th>
                                <th style="width: 100px;">Stok</th>
                                <th class="text-nowrap" style="width: 170px;">İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (list is null)
                            {
                                <tr><td colspan="6">Veriler yükleniyor...</td></tr>
                            }
                            else if (list.Count == 0)
                            {
                                <tr><td colspan="6">Henüz ürün yok.</td></tr>
                            }
                            else
                            {
                                @for (var i = 0; i < list.Count; i++)
                                {
                                    var u = list[i];
                                    var siraNo = i + 1;
                                    bool editing = editingId == u.UrunId;
                                    <tr class="@(editing ? "table-warning" : string.Empty)">
                                        <td class="fw-semibold">@siraNo</td>
                                        <td>
                                            @if (editing)
                                            {
                                                <input class="form-control form-control-sm" @bind="editModel.UrunAdi" />
                                            }
                                            else
                                            {
                                                @u.UrunAdi
                                            }
                                        </td>
                                        <td>
                                            @if (editing)
                                            {
                                                <input class="form-control form-control-sm" name="editSku" autocomplete="off" @bind="editModel.SKU" />
                                            }
                                            else
                                            {
                                                @u.SKU
                                            }
                                        </td>
                                        <td>
                                            @if (editing)
                                            {
                                                <input class="form-control form-control-sm" type="number" step="0.01" @bind="editModel.BirimFiyat" />
                                            }
                                            else
                                            {
                                                @u.BirimFiyat
                                            }
                                        </td>
                                        <td>
                                            @if (editing)
                                            {
                                                <input class="form-control form-control-sm" type="number" @bind="editModel.StokAdet" />
                                            }
                                            else
                                            {
                                                @u.StokAdet
                                            }
                                        </td>
                                        <td class="text-nowrap">
                                            @if (editing)
                                            {
                                                <button class="btn btn-success btn-sm me-1" @onclick="SaveEditAsync">Kaydet</button>
                                                <button class="btn btn-outline-secondary btn-sm me-1" @onclick="CancelEdit">Vazgeç</button>
                                                <button class="btn btn-danger btn-sm" @onclick="() => RemoveAsync(u.UrunId)">Sil</button>
                                            }
                                            else
                                            {
                                                <button class="btn btn-outline-warning btn-sm me-1" @onclick="() => StartEdit(u)">Güncelle</button>
                                                <button class="btn btn-outline-danger btn-sm" @onclick="() => RemoveAsync(u.UrunId)">Sil</button>
                                            }
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-xl-4 col-xxl-3">
        <div class="card border-success shadow-sm sticky-top" style="top: 90px;">
            <div class="card-header fw-bold py-2">Ürün Ekle</div>
            <div class="card-body p-3">
                <EditForm Model="newUrun" OnValidSubmit="AddAsync">
                    <DataAnnotationsValidator />
                    <ValidationSummary />
                    <div class="mb-2">
                        <label class="form-label mb-1" for="urunAdiInput">Ürün Adı</label>
                        <InputText id="urunAdiInput" class="form-control form-control-sm" autocomplete="off" @bind-Value="newUrun.UrunAdi" />
                        <ValidationMessage For="() => newUrun.UrunAdi" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label mb-1" for="skuInput">SKU</label>
                        <InputText id="skuInput" name="newSku" class="form-control form-control-sm" autocomplete="off" inputmode="text" @bind-Value="newUrun.SKU" />
                        <ValidationMessage For="() => newUrun.SKU" />
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label class="form-label mb-1" for="fiyatInput">Fiyat</label>
                            <InputNumber id="fiyatInput" class="form-control form-control-sm" TValue="decimal" @bind-Value="newUrun.BirimFiyat" />
                            <ValidationMessage For="() => newUrun.BirimFiyat" />
                        </div>
                        <div class="col-6">
                            <label class="form-label mb-1" for="stokInput">Stok</label>
                            <InputNumber id="stokInput" class="form-control form-control-sm" TValue="int" @bind-Value="newUrun.StokAdet" />
                            <ValidationMessage For="() => newUrun.StokAdet" />
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="reset" class="btn btn-outline-secondary btn-sm" @onclick="ResetNewForm">Temizle</button>
                        <button class="btn btn-success btn-sm" type="submit">Ekle</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
</div>

@code {
    List<Urun>? list;

    string? statusMessage;
    string statusClass = "alert-info";

    UrunInputModel newUrun = new();
    Urun editModel = new();
    int? editingId;

    protected override async Task OnInitializedAsync()
    {
        await RefreshAsync();
    }

    async Task RefreshAsync()
    {
        Db.ChangeTracker.Clear();
        list = await Db.Urunler
            .AsNoTracking()
            .OrderBy(x => x.UrunId)
            .ToListAsync();
        StateHasChanged();
    }

    void ResetNewForm() => newUrun = new();
    void CancelEdit()
    {
        editingId = null;
        editModel = new();
    }

    void StartEdit(Urun u)
    {
        editingId = u.UrunId;
        editModel = new Urun
        {
            UrunId = u.UrunId,
            UrunAdi = u.UrunAdi,
            SKU = u.SKU,
            BirimFiyat = u.BirimFiyat,
            StokAdet = u.StokAdet,
            AktifMi = u.AktifMi
        };
    }

    async Task AddAsync()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(newUrun.UrunAdi) || string.IsNullOrWhiteSpace(newUrun.SKU))
            {
                statusMessage = "Ürün adı ve SKU zorunludur.";
                statusClass = "alert-warning";
                return;
            }

            var sku = newUrun.SKU.Trim();
            var ad = newUrun.UrunAdi.Trim();

            var entity = new Urun
            {
                UrunAdi = ad,
                SKU = sku,
                BirimFiyat = newUrun.BirimFiyat,
                StokAdet = newUrun.StokAdet,
                AktifMi = true
            };

            await Db.Urunler.AddAsync(entity);
            await Db.SaveChangesAsync();
            statusMessage = "Ürün başarıyla eklendi.";
            statusClass = "alert-success";
            ResetNewForm();
            await RefreshAsync();
        }
        catch (Exception ex)
        {
            var detail = ex.InnerException?.Message ?? ex.Message;
            statusMessage = $"Ürün eklenirken hata oluştu: {detail}";
            statusClass = "alert-danger";
            Db.ChangeTracker.Clear();
            ResetNewForm();
        }
    }

    async Task SaveEditAsync()
    {
        try
        {
            if (editingId is null)
            {
                statusMessage = "Güncellenecek ürün seçili değil.";
                statusClass = "alert-warning";
                return;
            }

            if (string.IsNullOrWhiteSpace(editModel.UrunAdi) || string.IsNullOrWhiteSpace(editModel.SKU))
            {
                statusMessage = "Ürün adı ve SKU zorunludur.";
                statusClass = "alert-warning";
                return;
            }

            var ent = await Db.Urunler.FindAsync(editingId.Value);
            if (ent is not null)
            {
                ent.UrunAdi = editModel.UrunAdi.Trim();
                ent.SKU = editModel.SKU.Trim();
                ent.BirimFiyat = editModel.BirimFiyat;
                ent.StokAdet = editModel.StokAdet;
                ent.AktifMi = true;
                await Db.SaveChangesAsync();
                statusMessage = "Ürün güncellendi.";
                statusClass = "alert-success";
                CancelEdit();
                await RefreshAsync();
            }
            else
            {
                statusMessage = "Güncellenecek ürün bulunamadı.";
                statusClass = "alert-warning";
                CancelEdit();
            }
        }
        catch (Exception ex)
        {
            var detail = ex.InnerException?.Message ?? ex.Message;
            statusMessage = $"Ürün güncellenemedi: {detail}";
            statusClass = "alert-danger";
        }
    }

    async Task RemoveAsync(int id)
    {
        try
        {
            var ent = await Db.Urunler.FindAsync(id);
            if (ent is null)
            {
                statusMessage = "Silinecek ürün bulunamadı.";
                statusClass = "alert-warning";
                return;
            }

            await using var transaction = await Db.Database.BeginTransactionAsync();

            var relatedDetails = await Db.SiparisDetaylari
                .Where(d => d.UrunId == id)
                .ToListAsync();

            if (relatedDetails.Count > 0)
            {
                var affectedSiparisIds = relatedDetails
                    .Select(d => d.SiparisId)
                    .Distinct()
                    .ToList();

                Db.SiparisDetaylari.RemoveRange(relatedDetails);
                await Db.SaveChangesAsync();

                var emptyOrders = await Db.Siparisler
                    .Include(s => s.Detaylar)
                    .Where(s => affectedSiparisIds.Contains(s.SiparisId))
                    .ToListAsync();

                if (emptyOrders.Count > 0)
                {
                    var toRemove = emptyOrders
                        .Where(s => s.Detaylar.Count == 0)
                        .ToList();

                    if (toRemove.Count > 0)
                    {
                        Db.Siparisler.RemoveRange(toRemove);
                        await Db.SaveChangesAsync();
                    }
                }
            }

            Db.Urunler.Remove(ent);
            await Db.SaveChangesAsync();
            await transaction.CommitAsync();

            statusMessage = "Ürün ve ilişkili sipariş detayları silindi.";
            statusClass = "alert-success";
            if (editingId == id)
            {
                CancelEdit();
            }
            await RefreshAsync();
        }
        catch (Exception ex)
        {
            var detail = ex.InnerException?.Message ?? ex.Message;
            statusMessage = $"Ürün silinemedi: {detail}";
            statusClass = "alert-danger";
        }
    }

    public class UrunInputModel
    {
        [Required(ErrorMessage = "Ürün adı gereklidir.")]
        [MaxLength(200, ErrorMessage = "Ürün adı 200 karakteri geçemez.")]
        public string UrunAdi { get; set; } = string.Empty;

        [Required(ErrorMessage = "SKU gereklidir.")]
        [MaxLength(64, ErrorMessage = "SKU 64 karakteri geçemez.")]
        public string SKU { get; set; } = string.Empty;

        [Range(typeof(decimal), "0", "79228162514264337593543950335", ErrorMessage = "Fiyat 0'dan küçük olamaz.")]
        public decimal BirimFiyat { get; set; }

        [Range(0, int.MaxValue, ErrorMessage = "Stok negatif olamaz.")]
        public int StokAdet { get; set; }

        public bool AktifMi { get; set; } = true;
    }
}