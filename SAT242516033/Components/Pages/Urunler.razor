@page "/urunler"
@using Microsoft.EntityFrameworkCore
@using SAT242516033.Data
@using System.ComponentModel.DataAnnotations
@using UrunSiparisTakip.Models

@inject ApplicationDbContext Db

<h2 class="mt-3">Ürünler</h2>

@if (!string.IsNullOrWhiteSpace(_statusMessage))
{
    <div class="alert @_statusClass" role="alert">@_statusMessage</div>
}

@if (_operation == "list")
{
    <div class="d-flex justify-content-between align-items-center mb-2">
        <button class="btn btn-outline-success" @onclick="OnClick_New">Yeni</button>
        <button class="btn btn-outline-primary" @onclick="RefreshAsync">Listeyi Yenile</button>
    </div>

    <table class="table table-striped align-middle">
        <thead>
            <tr>
                <th style="width: 150px;">İşlemler</th>
                <th>#</th>
                <th>Ad</th>
                <th>SKU</th>
                <th>Fiyat</th>
                <th>Stok</th>
            </tr>
        </thead>
        <tbody>
            @if (_list is null)
            {
                <tr><td colspan="6">Veriler yükleniyor...</td></tr>
            }
            else if (_list.Count == 0)
            {
                <tr><td colspan="6">Henüz ürün yok.</td></tr>
            }
            else
            {
                @for (var i = 0; i < _list.Count; i++)
                {
                    var item = _list[i];
                    <tr>
                        <td class="text-nowrap">
                            <button class="btn btn-outline-warning btn-sm me-1" @onclick="() => OnClick_Edit(item.UrunId)">Güncelle</button>
                            <button class="btn btn-outline-danger btn-sm" @onclick="() => OnClick_Remove(item.UrunId)">Sil</button>
                        </td>
                        <td>@(i + 1)</td>
                        <td>@item.UrunAdi</td>
                        <td>@item.SKU</td>
                        <td>@item.BirimFiyat</td>
                        <td>@item.StokAdet</td>
                    </tr>
                }
            }
        </tbody>
    </table>
}

@if (_operation == "new")
{
    <h5>Yeni Ürün</h5>
    <div class="mb-2">
        <label>Ürün Adı</label>
        <input class="form-control" @bind="_model.UrunAdi" />
    </div>
    <div class="mb-2">
        <label>SKU</label>
        <input class="form-control" autocomplete="off" @bind="_model.SKU" />
    </div>
    <div class="row g-2 mb-2">
        <div class="col-md-6">
            <label>Fiyat</label>
            <input class="form-control" type="number" step="0.01" @bind="_model.BirimFiyat" />
        </div>
        <div class="col-md-6">
            <label>Stok</label>
            <input class="form-control" type="number" @bind="_model.StokAdet" />
        </div>
    </div>
    <button class="btn btn-success me-2" @onclick="OnClick_Add">Ekle</button>
    <button class="btn btn-outline-dark" @onclick="OnClick_Cancel">Vazgeç</button>
}

@if (_operation == "edit")
{
    <h5>Ürün Güncelle</h5>
    <div class="mb-2">
        <label>Ürün Adı</label>
        <input class="form-control" @bind="_model.UrunAdi" />
    </div>
    <div class="mb-2">
        <label>SKU</label>
        <input class="form-control" autocomplete="off" @bind="_model.SKU" />
    </div>
    <div class="row g-2 mb-2">
        <div class="col-md-6">
            <label>Fiyat</label>
            <input class="form-control" type="number" step="0.01" @bind="_model.BirimFiyat" />
        </div>
        <div class="col-md-6">
            <label>Stok</label>
            <input class="form-control" type="number" @bind="_model.StokAdet" />
        </div>
    </div>
    <button class="btn btn-warning me-2" @onclick="OnClick_Update">Güncelle</button>
    <button class="btn btn-outline-dark" @onclick="OnClick_Cancel">Vazgeç</button>
}

@if (_operation == "remove")
{
    <h5>Ürünü Sil</h5>
    <p>"@_model.UrunAdi" adlı ürünü silmek istediğinize emin misiniz?</p>
    <button class="btn btn-danger me-2" @onclick="OnClick_Save">Sil</button>
    <button class="btn btn-outline-dark" @onclick="OnClick_Cancel">Vazgeç</button>
}

@code {
    private string _operation = "list";

    private List<Urun>? _list;
    private UrunFormModel _model = new();

    private string? _statusMessage;
    private string _statusClass = "alert-info";

    protected override async Task OnInitializedAsync()
    {
        await RefreshAsync();
    }

    private async Task RefreshAsync()
    {
        Db.ChangeTracker.Clear();
        _list = await Db.Urunler
            .AsNoTracking()
            .OrderBy(x => x.UrunId)
            .ToListAsync();
        StateHasChanged();
    }

    private void OnClick_New()
    {
        _operation = "new";
        _model = new();
    }

    private void OnClick_Edit(int? id)
    {
        _operation = "edit";
        var ent = _list?.FirstOrDefault(x => x.UrunId == id);
        if (ent is not null)
        {
            _model = new UrunFormModel
            {
                UrunId = ent.UrunId,
                UrunAdi = ent.UrunAdi,
                SKU = ent.SKU,
                BirimFiyat = ent.BirimFiyat,
                StokAdet = ent.StokAdet
            };
        }
    }

    private void OnClick_Remove(int? id)
    {
        _operation = "remove";
        var ent = _list?.FirstOrDefault(x => x.UrunId == id);
        if (ent is not null)
        {
            _model = new UrunFormModel
            {
                UrunId = ent.UrunId,
                UrunAdi = ent.UrunAdi,
                SKU = ent.SKU,
                BirimFiyat = ent.BirimFiyat,
                StokAdet = ent.StokAdet
            };
        }
    }

    private void OnClick_Cancel()
    {
        _operation = "list";
        _statusMessage = null;
    }

    private async Task OnClick_Add()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(_model.UrunAdi) || string.IsNullOrWhiteSpace(_model.SKU))
            {
                _statusMessage = "Ürün adı ve SKU zorunludur.";
                _statusClass = "alert-warning";
                return;
            }

            var entity = new Urun
            {
                UrunAdi = _model.UrunAdi.Trim(),
                SKU = _model.SKU.Trim(),
                BirimFiyat = _model.BirimFiyat,
                StokAdet = _model.StokAdet,
                AktifMi = true
            };

            await Db.Urunler.AddAsync(entity);
            await Db.SaveChangesAsync();
            _statusMessage = "Ürün başarıyla eklendi.";
            _statusClass = "alert-success";
            _operation = "list";
            await RefreshAsync();
        }
        catch (Exception ex)
        {
            var detail = ex.InnerException?.Message ?? ex.Message;
            _statusMessage = $"Ürün eklenirken hata oluştu: {detail}";
            _statusClass = "alert-danger";
            Db.ChangeTracker.Clear();
        }
    }

    private async Task OnClick_Update()
    {
        try
        {
            if (_model.UrunId is null)
            {
                _statusMessage = "Güncellenecek ürün bulunamadı.";
                _statusClass = "alert-warning";
                return;
            }

            if (string.IsNullOrWhiteSpace(_model.UrunAdi) || string.IsNullOrWhiteSpace(_model.SKU))
            {
                _statusMessage = "Ürün adı ve SKU zorunludur.";
                _statusClass = "alert-warning";
                return;
            }

            var ent = await Db.Urunler.FindAsync(_model.UrunId.Value);
            if (ent is not null)
            {
                ent.UrunAdi = _model.UrunAdi.Trim();
                ent.SKU = _model.SKU.Trim();
                ent.BirimFiyat = _model.BirimFiyat;
                ent.StokAdet = _model.StokAdet;
                ent.AktifMi = true;
                await Db.SaveChangesAsync();
                _statusMessage = "Ürün güncellendi.";
                _statusClass = "alert-success";
                _operation = "list";
                await RefreshAsync();
            }
            else
            {
                _statusMessage = "Güncellenecek ürün bulunamadı.";
                _statusClass = "alert-warning";
            }
        }
        catch (Exception ex)
        {
            var detail = ex.InnerException?.Message ?? ex.Message;
            _statusMessage = $"Ürün güncellenemedi: {detail}";
            _statusClass = "alert-danger";
        }
    }

    private async Task OnClick_Save()
    {
        if (_model.UrunId is null)
        {
            _statusMessage = "Silinecek ürün bulunamadı.";
            _statusClass = "alert-warning";
            return;
        }

        await RemoveAsync(_model.UrunId.Value);
        _operation = "list";
    }

    private async Task RemoveAsync(int id)
    {
        try
        {
            var ent = await Db.Urunler.FindAsync(id);
            if (ent is null)
            {
                _statusMessage = "Silinecek ürün bulunamadı.";
                _statusClass = "alert-warning";
                return;
            }

            await using var transaction = await Db.Database.BeginTransactionAsync();

            var relatedDetails = await Db.SiparisDetaylari
                .Where(d => d.UrunId == id)
                .ToListAsync();

            if (relatedDetails.Count > 0)
            {
                var affectedSiparisIds = relatedDetails
                    .Select(d => d.SiparisId)
                    .Distinct()
                    .ToList();

                Db.SiparisDetaylari.RemoveRange(relatedDetails);
                await Db.SaveChangesAsync();

                var emptyOrders = await Db.Siparisler
                    .Include(s => s.Detaylar)
                    .Where(s => affectedSiparisIds.Contains(s.SiparisId))
                    .ToListAsync();

                if (emptyOrders.Count > 0)
                {
                    var toRemove = emptyOrders
                        .Where(s => s.Detaylar.Count == 0)
                        .ToList();

                    if (toRemove.Count > 0)
                    {
                        Db.Siparisler.RemoveRange(toRemove);
                        await Db.SaveChangesAsync();
                    }
                }
            }

            Db.Urunler.Remove(ent);
            await Db.SaveChangesAsync();
            await transaction.CommitAsync();

            _statusMessage = "Ürün ve ilişkili sipariş detayları silindi.";
            _statusClass = "alert-success";
            await RefreshAsync();
        }
        catch (Exception ex)
        {
            var detail = ex.InnerException?.Message ?? ex.Message;
            _statusMessage = $"Ürün silinemedi: {detail}";
            _statusClass = "alert-danger";
        }
    }

    public class UrunFormModel
    {
        public int? UrunId { get; set; }

        [Required(ErrorMessage = "Ürün adı gereklidir.")]
        [MaxLength(200, ErrorMessage = "Ürün adı 200 karakteri geçemez.")]
        public string UrunAdi { get; set; } = string.Empty;

        [Required(ErrorMessage = "SKU gereklidir.")]
        [MaxLength(64, ErrorMessage = "SKU 64 karakteri geçemez.")]
        public string SKU { get; set; } = string.Empty;

        [Range(typeof(decimal), "0", "79228162514264337593543950335", ErrorMessage = "Fiyat 0'dan küçük olamaz.")]
        public decimal BirimFiyat { get; set; }

        [Range(0, int.MaxValue, ErrorMessage = "Stok negatif olamaz.")]
        public int StokAdet { get; set; }

        public bool AktifMi { get; set; } = true;
    }
}